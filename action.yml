name: 'CI/CD and manual prod deployments using ssh+github'
description: 'This will run deployment to stage server on every push to master and contains a manual workflow for deploying to production.'
author: 'Patrik Grinsvall'
inputs:
  STAGE_SSH_HOST:
    description: 'ssh host'
  STAGE_SSH_PORT:
    description: 'ssh port'
    default: 22
  STAGE_SSH_PRIVATE_KEY:
    description: 'private key in NOT IN OPENSSH FORMAT but in RSA PRIVATE KEY format.
  STAGE_SSH_HOST:
  STAGE_SSH_USER:
  STAGE_REPO_PATH:
  PROD_SSH_PRIVATE_KEY:
  PROD_SSH_HOST:
  PROD_SSH_PORT:
  PROD_SSH_USER:
  PROD_REPO_PATH:
  
  using: "composite"
  steps: 
   env:
      STAGE_SSH_KEY: "${{ inputs.STAGE_SSH_PRIVATE_KEY }}"
      STAGE_SSH_HOST: "${{ inputs.STAGE_SSH_HOST }}"
      STAGE_SSH_PORT: "${{ inputs.STAGE_SSH_PORT }}"
      STAGE_SSH_USER: "${{ inputs.STAGE_SSH_USER }}"
      STAGE_REMOTE_PATH: "${{ inputs.STAGE_REPO_PATH }}"
      PROD_SSH_KEY: "${{ inputs.PROD_SSH_PRIVATE_KEY }}"
      PROD_SSH_HOST: "${{ inputs.PROD_SSH_HOST }}"
      PROD_SSH_PORT: "${{ inputs.PROD_SSH_PORT }}"
      PROD_SSH_USER: "${{ inputs.PROD_SSH_USER }}"
      PROD_REMOTE_PATH: "${{ inputs.PROD_REPO_PATH }}" 
    - id: deploystage
      run: |
          mkdir -p ~/.ssh
          echo "$STAGE_SSH_KEY" > ~/.ssh/stage_id_rsa
          sudo chmod 600 ~/.ssh/stage_id_rsa
          chmod 600 ~/.ssh/stage_id_rsa
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/stage_id_rsa
          ssh -i ~/.ssh/stage_id_rsa -o StrictHostKeyChecking=no -p $STAGE_SSH_PORT $STAGE_SSH_USER@$STAGE_SSH_HOST "cd $STAGE_REMOTE_PATH && ls -al"
   - id: deployprod
     run: |
      echo "start on prod"
      if [ "${{ github.event.inputs.deployprod }}" != "YES" ]; then echo "Not running prod" && exit; fi;
      
